<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="<%= typeof pageDescription !== 'undefined' ? pageDescription : 'A simple CMS built with Bootstrap 5 and EJS' %>"
    />
    <title><%= title %> | JS-Dev Starter</title>

    <!-- Structured data for SEO -->
    <script type="application/ld+json"<% if (typeof cspNonce !== 'undefined') { %> nonce="<%- cspNonce %>"<% } %>>
      {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "<%= typeof title !== 'undefined' ? title + ' | JS-Dev Starter' : 'JS-Dev Starter' %>",
        "url": "<%= typeof absoluteUrl !== 'undefined' ? absoluteUrl : 'https://yourwebsite.com' %>",
        "description": "<%= typeof pageDescription !== 'undefined' ? pageDescription : 'A simple CMS built with Bootstrap 5 and EJS' %>"
      }
    </script>

    <link href="/css/styles.css" rel="stylesheet" />
    <link href="/css/dependencies.css" rel="stylesheet" />
    <link href="/fonts/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body class="flex-layout">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="/"
          ><i class="bi bi-house"></i> JS-Dev Starter</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <!-- Documentation Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-book"></i> Documentation
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/getting-started"><i class="bi bi-play-circle me-2"></i>Getting Started</a></li>
                <li><a class="dropdown-item" href="/github-pages"><i class="bi bi-github me-2"></i>GitHub Pages</a></li>
              </ul>
            </li>

            <!-- Components Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-grid-3x3-gap"></i> Components
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/components"><i class="bi bi-puzzle me-2"></i>Basic Components</a></li>
                <li><a class="dropdown-item" href="/advanced-components"><i class="bi bi-gear-wide-connected me-2"></i>Advanced Components</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/data-tables"><i class="bi bi-table me-2"></i>Data Tables</a></li>
              </ul>
            </li>

            <!-- Community Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-people"></i> Community
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/community"><i class="bi bi-heart me-2"></i>Community & Contributing</a></li>
              </ul>
            </li>

            <!-- Dark mode toggle -->
            <li class="nav-item ms-2 d-flex align-items-center">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  id="darkModeToggle"
                />
                <label class="form-check-label" for="darkModeToggle"
                  ><i class="bi bi-sun-fill"></i
                ></label>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main content area -->
    <main class="container my-5 pt-3 pb-5 flex-main">
      <% if (typeof content !== 'undefined' && !content.useCustomTemplate) { %>
      <h1 class="mb-4"><%- content.heading %></h1>
      <p class="lead"><%- content.text %></p>
      <div class="content-body"><%- content.body %></div>
      <% } else { %> <%- body %> <% } %>
    </main>

    <!-- Footer -->
    <footer class="footer py-3 mt-auto">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <span class="text-muted"
              >Â© <%= new Date().getFullYear() %> JS-Dev Starter. All rights
              reserved.</span
            >
            <span class="text-muted ms-2">|</span>
            <a
              href="https://markhazleton.com"
              class="text-muted ms-2"
              target="_blank"
            >
              Created by Mark Hazleton
              <i class="bi bi-box-arrow-up-right small"></i>
            </a>
            <% if (typeof buildInfo !== 'undefined') { %>
            <div class="mt-1">
              <small class="text-muted">
                v<%= buildInfo.version %> | Built: <%= buildInfo.buildDate %>
              </small>
            </div>
            <% } %>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="https://github.com/markhazleton" class="text-muted me-2"
              ><i class="bi bi-github"></i
            ></a>
            <a
              href="https://www.linkedin.com/in/markhazleton/"
              class="text-muted"
              ><i class="bi bi-linkedin"></i
            ></a>
          </div>
        </div>
      </div>
    </footer>
    <script src="/js/dependencies.min.js"></script>
    <script src="/js/service-worker-register.js"></script>
    <script src="/js/theme-toggle.js"></script>
    <script src="/js/theme-demo.js"></script>
    <script src="/js/component-library.js"></script>
    
    <!-- Conditional scripts based on page -->
    <% if (typeof songId !== 'undefined') { %>
    <!-- Song Detail Page JavaScript -->
    <script<% if (typeof cspNonce !== 'undefined') { %> nonce="<%- cspNonce %>"<% } %>>
    console.log('Song detail page loading for songId:', '<%= songId %>');
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      const songId = '<%= songId %>';
      
      // Get container elements
      const loadingContainer = document.getElementById('loading-container');
      const songContainer = document.getElementById('song-container');
      
      fetch('/api/song/' + songId)
        .then(function(response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function(data) {
          console.log('Song data loaded:', data.title);
          
          // Show content container first
          if (loadingContainer) loadingContainer.classList.add('d-none');
          if (songContainer) songContainer.classList.remove('d-none');
          
          // Populate all text elements
          const elements = [
            { id: 'song-title', value: data.title || 'Unknown Title' },
            { id: 'rank-number', value: data.rank || 'N/A' },
            { id: 'channel-name', value: data.channel || 'Unknown Channel' },
            { id: 'song-views', value: data.views || 'N/A' },
            { id: 'song-duration', value: data.duration || 'N/A' },
            { id: 'song-followers', value: data.followers || 'N/A' },
            { id: 'views-large', value: data.views || 'N/A' },
            { id: 'duration-large', value: data.duration || 'N/A' },
            { id: 'followers-large', value: data.followers || 'N/A' },
            { id: 'song-full-title', value: data.fullTitle || data.title || 'Unknown Title' },
            { id: 'category-badge', value: data.category || 'Music' }
          ];
          
          elements.forEach(function(item) {
            const element = document.getElementById(item.id);
            if (element) {
              element.textContent = item.value;
            }
          });
          
          // Handle channel link
          const channelLink = document.getElementById('channel-link');
          const channelUrlContainer = document.getElementById('channel-url-container');
          if (channelLink && data.channelUrl) {
            channelLink.href = data.channelUrl;
            if (channelUrlContainer) channelUrlContainer.classList.remove('d-none');
          } else if (channelUrlContainer) {
            channelUrlContainer.classList.add('d-none');
          }
          
          // Handle thumbnail
          const thumbnailImg = document.getElementById('song-thumbnail');
          const thumbnailContainer = document.getElementById('thumbnail-container');
          const noThumbnail = document.getElementById('no-thumbnail');
          if (thumbnailImg && data.thumbnail) {
            thumbnailImg.src = data.thumbnail;
            thumbnailImg.alt = data.title + ' thumbnail';
            if (thumbnailContainer) thumbnailContainer.classList.remove('d-none');
            if (noThumbnail) noThumbnail.classList.add('d-none');
          } else {
            if (thumbnailContainer) thumbnailContainer.classList.add('d-none');
            if (noThumbnail) noThumbnail.classList.remove('d-none');
          }
          
          // Handle description
          const descContainer = document.getElementById('song-description');
          const descCard = document.getElementById('description-card');
          if (descContainer && data.description) {
            // Format description with line breaks and links
            const formattedDesc = data.description
              .replace(/\n/g, '<br>')
              .replace(/https?:\/\/[^\s\n]+/g, function(url) {
                return '<a href="' + url + '" target="_blank" class="text-primary text-decoration-none">' + url + ' <i class="bi bi-box-arrow-up-right small"></i></a>';
              });
            descContainer.innerHTML = formattedDesc;
            if (descCard) descCard.classList.remove('d-none');
          } else if (descCard) {
            descCard.classList.add('d-none');
          }
          
          // Handle tags
          const tagsContainer = document.getElementById('song-tags');
          const tagsCard = document.getElementById('tags-card');
          if (tagsContainer && data.tags) {
            const tagList = data.tags.split(/[;,]/).map(function(tag) { return tag.trim(); }).filter(function(tag) { return tag; });
            if (tagList.length > 0) {
              tagsContainer.innerHTML = tagList.map(function(tag) {
                return '<span class="badge bg-light text-dark border">' + tag + '</span>';
              }).join(' ');
              if (tagsCard) tagsCard.classList.remove('d-none');
            } else if (tagsCard) {
              tagsCard.classList.add('d-none');
            }
          } else if (tagsCard) {
            tagsCard.classList.add('d-none');
          }
          
          // Setup navigation
          const prevBtn = document.getElementById('prev-song');
          const nextBtn = document.getElementById('next-song');
          const currentRank = parseInt(data.rank) || 1;
          
          if (prevBtn) {
            if (currentRank > 1) {
              prevBtn.onclick = function() { window.location.href = '/song/' + (currentRank - 1); };
              prevBtn.disabled = false;
            } else {
              prevBtn.disabled = true;
            }
          }
          
          if (nextBtn) {
            if (currentRank < 100) {
              nextBtn.onclick = function() { window.location.href = '/song/' + (currentRank + 1); };
              nextBtn.disabled = false;
            } else {
              nextBtn.disabled = true;
            }
          }
          
          // Update page title
          document.title = (data.title || 'Unknown') + ' - ' + (data.channel || 'Unknown') + ' | Song Details';
        })
        .catch(function(error) {
          console.error('API Error:', error);
        });
    });
    </script>
    <% } %>
  </body>
</html>
